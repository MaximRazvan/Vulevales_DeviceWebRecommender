<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" >
  <meta name="viewport" content="width=device-width, initial-scale=1.0" >
  <title>Produsele mele favorite - Recomandări Dispozitive Electronice</title>
  <link rel="icon" href="ico.jpg" type="image/jpeg">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="favorites.css"> </head>
<body>
  <header>
     <a href="/">
        <h1>Recomandări Dispozitive Electronice</h1>
     </a>
  </header>

  <main>
    <section id="favoritesListContainer">
      <button id="backToHome">Înapoi la pagina principala</button>
      <h2>Produsele mele favorite</h2>
      <div id="favoritesGrid">
        </div>
      <p id="loadingMessage" class="message">Se încarca produsele favorite...</p>
      <p id="errorMessage" class="message error" style="display: none;"></p>
      <p id="noFavoritesMessage" class="message" style="display: none;">Nu ai produse adaugate la favorite.</p>
    </section>
  </main>

  <footer>
    <a href="/rss">RSS Feed</a>
  </footer>

  <script>
    const favoritesGrid = document.getElementById('favoritesGrid');
    const loadingMessage = document.getElementById('loadingMessage');
    const errorMessage = document.getElementById('errorMessage');
    const noFavoritesMessage = document.getElementById('noFavoritesMessage');
    const backToHomeButton = document.getElementById('backToHome');

    // Functie pentru a prelua si afisa favoritele utilizatorului
    async function fetchAndDisplayFavorites() {
        loadingMessage.style.display = 'block';
        errorMessage.style.display = 'none';
        noFavoritesMessage.style.display = 'none';
        favoritesGrid.innerHTML = ''; 

        const token = localStorage.getItem('token');
        if (!token) {
            loadingMessage.style.display = 'none';
            errorMessage.textContent = 'Nu sunteti autentificat. Va rugam sa va conectati pentru a vedea favoritele.';
            errorMessage.style.display = 'block';
            return;
        }

        try {
            const res = await fetch('/api/favorites', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!res.ok) {
                const errorData = await res.json();
                loadingMessage.style.display = 'none';
                errorMessage.textContent = `Eroare la preluarea favoritelor: ${errorData.message || res.statusText}`;
                errorMessage.style.display = 'block';
                return;
            }

            const favorites = await res.json();
            loadingMessage.style.display = 'none';

            if (favorites.length === 0) {
                noFavoritesMessage.style.display = 'block';
                return;
            }

            favorites.forEach(device => {
                const div = document.createElement('div');
                div.className = 'device-card';
                div.dataset.productId = device.id;

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'device-actions';

                const removeFavoriteButton = document.createElement('button');
                removeFavoriteButton.textContent = 'Elimina din Favorite';
                removeFavoriteButton.className = 'remove-favorite-btn';
                removeFavoriteButton.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    if (confirm('Esti sigur ca vrei sa elimini acest produs din favorite?')) {
                        await removeFromFavorites(device.id);
                        fetchAndDisplayFavorites();
                    }
                });
                actionsDiv.appendChild(removeFavoriteButton);
                div.insertBefore(actionsDiv, div.firstChild);

                // Add image element
                if (device.image) {
                    const img = document.createElement('img');
                    img.src = device.image;
                    img.alt = device.name;
                    img.className = 'product-image';
                    div.appendChild(img);
                } else {
                    const placeholder = document.createElement('div');
                    placeholder.className = 'product-image-placeholder';
                    placeholder.textContent = 'Fara imagine';
                    div.appendChild(placeholder);
                }


                const contentHTML = `
                  <h3>${device.name}</h3>
                  <p>Pret: ${device.price} Lei</p>
                  <p>Caracteristici: ${device.features.join(', ')}</p>
                `;
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = contentHTML;
                while(tempDiv.firstChild) {
                    div.appendChild(tempDiv.firstChild);
                }

                div.addEventListener('click', (e) => {
                    if (!e.target.closest('.device-actions button')) {
                        window.location.href = `/product-details.html?product_id=${device.id}`;
                    }
                });
                favoritesGrid.appendChild(div);
            });

        } catch (error) {
            console.error('Eroare la preluarea si afisarea favoritelor:', error);
            loadingMessage.style.display = 'none';
            errorMessage.textContent = 'A aparut o eroare de retea la încarcarea favoritelor.';
            errorMessage.style.display = 'block';
        }
    }

    // Functie pentru eliminarea din favorite (similara cu cea din index.html)
    async function removeFromFavorites(productId) {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('Trebuie sa fii autentificat pentru a elimina produse din favorite.');
            return;
        }
        try {
            const response = await fetch(`/api/favorites/${productId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            if (response.ok) {
            } else {
                alert(data.message || 'Eroare la eliminarea din favorite.');
            }
        } catch (error) {
            console.error('Eroare la eliminarea din favorite:', error);
            alert('A aparut o eroare de retea la eliminarea din favorite.');
        }
    }

    // Event listener pentru butonul "Înapoi la pagina principala"
    backToHomeButton.addEventListener('click', () => {
        window.location.href = '/';
    });

    // La încarcarea paginii de favorite, preia si afiseaza produsele favorite
    document.addEventListener('DOMContentLoaded', fetchAndDisplayFavorites);
  </script>
</body>
</html>