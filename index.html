<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" >
  <meta name="viewport" content="width=device-width, initial-scale=1.0" >
  <title>Recomandări Dispozitive Electronice</title>
  <link rel="icon" href="ico.jpg" type="image/jpeg">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="index.css"> </head>
<body>
  <header>
    <a href="/">
        <h1>Recomandări Dispozitive Electronice</h1>
    </a>
    <div class="header-top-left-actions">
        <button id="viewStatsButton">Vezi Statistici</button>
        <button id="viewDocsButton">Documentație</button>
    </div>
    <div class="header-top-right-status">
         <button id="userStatusButton" style="display: none;"></button>
         <button id="logoutButton" style="display: none;">Deconectare</button>
    </div>

    <div class="header-actions">
        <button id="addProductButton" style="display: none;">Adaugă Produs</button>
        <button id="viewFavoritesButton" style="display: none;">Favoritele mele</button>
        <button id="loginButton">Conectare/Înregistrare</button>
        </div>
    <input type="text" id="searchInput" placeholder="Caută dupa model sau caracteristici...">
    <div id="filters">
      <input type="number" id="minPrice" placeholder="Preț minim" min="0">
      <input type="number" id="maxPrice" placeholder="Preț maxim" min="0">
      <input type="number" id="batteryLife" placeholder="Autonomie (ore)" min="0">
      <select id="deviceType">
        <option value="">Toate tipurile</option>
        <option value="telefon">Telefon</option>
        <option value="tableta">Tableta</option>
        <option value="ceas">Ceas</option>
        <option value="drona">Drona</option>
        <option value="laptop">Laptop</option>
        <option value="casti">Casti</option>
      </select>
    </div>
  </header>

  <main>
    <section id="recommendationsList">
        <h2>Recomandări</h2>
        <div id="recommendations"></div>
    </section>
  </main>

  <footer>
    <div class="rss-box">
        <a href="/rss">RSS Feed</a>
    </div>
  </footer>

  <div id="loginModal" class="modal">
    <div class="modal-content">
      <span class="close-button login-close-button">×</span>
      <h2>Conectare</h2>
      <form id="loginForm">
        <label for="loginUsername">Nume utilizator:</label>
        <input type="text" id="loginUsername" name="username" required>
        <label for="loginPassword">Parola:</label>
        <div class="password-container">
            <input type="password" id="loginPassword" name="password" required>
            <button type="button" class="toggle-password">Arată</button>
        </div>
        <div class="modal-buttons">
          <button type="button" id="loginSubmit">Conectare</button>
          <button type="button" id="openRegisterModal">Înregistrare</button>
        </div>
      </form>
      <div id="loginStatusMessage" class="status-message"></div>
    </div>
  </div>

  <div id="registerModal" class="modal">
    <div class="modal-content">
      <span class="close-button register-close-button">×</span>
      <h2>Înregistrare</h2>
      <form id="registerForm">
        <label for="registerUsername">Nume utilizator:</label>
        <input type="text" id="registerUsername" name="username" required>

        <label for="registerEmail">Email:</label>
        <input type="email" id="registerEmail" name="email" required>

        <label for="registerPassword">Parola:</label>
        <div class="password-container">
            <input type="password" id="registerPassword" name="password" required>
            <button type="button" class="toggle-password">Arată</button>
        </div>

        <label for="registerConfirmPassword">Confirmare Parola:</label>
        <div class="password-container">
            <input type="password" id="registerConfirmPassword" name="confirm_password" required>
            <button type="button" class="toggle-password">Arată</button>
        </div>

        <div class="modal-buttons">
          <button type="button" id="registerSubmit">Înregistrare</button>
        </div>
      </form>
      <div id="registerStatusMessage" class="status-message"></div>
    </div>
  </div>

    <div id="addProductModal" class="modal">
    <div class="modal-content">
      <span class="close-button add-product-close-button">×</span>
      <h2>Adaugă Produs Nou</h2>
      <form id="productForm">
        <label for="productNameInput">Nume Produs:</label>
        <input type="text" id="productNameInput" required>

        <label for="productPriceInput">Preț:</label>
        <input type="number" id="productPriceInput" step="0.01" required min="0">

        <label for="productBatteryLifeInput">Autonomie Baterie (ore):</label>
        <input type="number" id="productBatteryLifeInput" min="0">

        <label for="productTypeInput">Tip Produs:</label>
        <select id="productTypeInput" required>
            <option value="">Selecteaza un tip</option>
            <option value="telefon">Telefon</option>
            <option value="tableta">Tableta</option>
            <option value="ceas">Ceas</option>
            <option value="drona">Drona</option>
            <option value="laptop">Laptop</option>
            <option value="casti">Casti</option>
        </select>

        <label for="productFeaturesInput">Caracteristici (separate prin virgula):</label>
        <input type="text" id="productFeaturesInput" placeholder="Ex: 5G, iOS, Face ID" required>

        <label for="productLinkInput">Link Produs (optional):</label>
        <input type="url" id="productLinkInput" placeholder="Ex: https://exemplu.com/produs">

        <label for="productImageInput">URL Imagine Produs (optional):</label>
        <input type="url" id="productImageInput" placeholder="Ex: https://exemplu.com/imagine.jpg">

        <div class="modal-buttons">
          <button type="submit" id="submitProduct">Adaugă Produs</button>
        </div>
      </form>
      <div id="addProductStatusMessage" class="status-message"></div>
    </div>
  </div>

    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <span class="close-button edit-product-close-button">×</span>
            <h2>Editează Produs</h2>
            <form id="editProductForm">
                <input type="hidden" id="editProductId">

                <label for="editProductNameInput">Nume Produs:</label>
                <input type="text" id="editProductNameInput" required>

                <label for="editProductPriceInput">Preț:</label>
                <input type="number" id="editProductPriceInput" step="0.01" required min="0">

                <label for="editProductBatteryLifeInput">Autonomie Baterie (ore):</label>
                <input type="number" id="editProductBatteryLifeInput" min="0">

                <label for="editProductTypeInput">Tip Produs:</label>
                <select id="editProductTypeInput" required>
                    <option value="">Selecteaza un tip</option>
                    <option value="telefon">Telefon</option>
                    <option value="tableta">Tableta</option>
                    <option value="ceas">Ceas</option>
                    <option value="drona">Drona</option>
                    <option value="laptop">Laptop</option>
                    <option value="casti">Casti</option>
                </select>

                <label for="editProductFeaturesInput">Caracteristici (separate prin virgula):</label>
                <input type="text" id="editProductFeaturesInput" placeholder="Ex: 5G, iOS, Face ID" required>

                <label for="editProductLinkInput">Link Produs (optional):</label>
                <input type="url" id="editProductLinkInput" placeholder="Ex: https://exemplu.com/produs">

                <label for="editProductImageInput">URL Imagine Produs (optional):</label>
                <input type="url" id="editProductImageInput" placeholder="Ex: https://exemplu.com/imagine.jpg">

                <div class="modal-buttons">
                    <button type="submit" id="updateProduct">Actualizeaza Produs</button>
                </div>
            </form>
            <div id="editProductStatusMessage" class="status-message"></div>
        </div>
    </div>


  <script>
    const recommendationsListSection = document.getElementById('recommendationsList');
    
    //Referinte pentru butoane
    const userStatusButton = document.getElementById('userStatusButton');
    const viewStatsButton = document.getElementById('viewStatsButton');
    const viewDocsButton = document.getElementById('viewDocsButton'); 

    async function fetchRecommendations(query = '') {
      const minPrice = document.getElementById('minPrice').value;
      const maxPrice = document.getElementById('maxPrice').value;
      const batteryLife = document.getElementById('batteryLife').value;
      const deviceType = document.getElementById('deviceType').value;
      const userRole = localStorage.getItem('userRole');
      const token = localStorage.getItem('token');

      const params = new URLSearchParams({
        q: query,
        minPrice,
        maxPrice,
        batteryLife,
        deviceType
      });

      try {
          const res = await fetch(`/api/recommendations?${params.toString()}`);
          if (!res.ok) {
              console.error('Failed to fetch recommendations:', res.status, res.statusText);
               document.getElementById('recommendations').innerHTML = '<p class="no-results error">Eroare la încarcarea Recomandărilor.</p>';
               return;
          }
          let data = await res.json();
          const container = document.getElementById('recommendations');
          container.innerHTML = '';

          if (data.length === 0) {
            container.innerHTML = '<p class="no-results">Nu s-au gasit Recomandări conform filtrelor.</p>';
            return;
          }

          if (token) {
              const favoriteProductIds = new Set();
              try {
                  const favRes = await fetch('/api/favorites', {
                      headers: { 'Authorization': `Bearer ${token}` }
                  });
                  if (favRes.ok) {
                      const favProducts = await favRes.json();
                      favProducts.forEach(fav => favoriteProductIds.add(fav.id));
                  } else {
                      console.warn('Nu s-a putut prelua lista de favorite:', favRes.status);
                  }
              } catch (favError) {
                  console.error('Eroare la preluarea listei de favorite pentru UI:', favError);
              }

              data = data.map(device => ({
                  ...device,
                  isFavorited: favoriteProductIds.has(device.id)
              }));
          }


          data.forEach(device => {
            const div = document.createElement('div');
            div.className = 'device-card';
            if (device.isFavorited) {
                div.classList.add('is-favorited-card');
            }
            div.dataset.productId = device.id;

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'device-actions';

            if (userRole === 'admin') {
                const editButton = document.createElement('button');
                editButton.textContent = 'Editează';
                editButton.className = 'edit-btn';
                editButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditProductModal(device.id);
                });

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Șterge';
                deleteButton.className = 'delete-btn';
                deleteButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('Esti sigur ca vrei sa stergi acest produs?')) {
                        deleteProduct(device.id);
                    }
                });
                actionsDiv.appendChild(editButton);
                actionsDiv.appendChild(deleteButton);
            }

            if (token) {
                const favoriteButton = document.createElement('button');
                favoriteButton.textContent = device.isFavorited ? 'Elimină din Favorite' : 'Adaugă la Favorite';
                favoriteButton.className = 'favorite-btn';
                if (device.isFavorited) {
                    favoriteButton.classList.add('favorited');
                }
                favoriteButton.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    if (device.isFavorited) {
                        await removeFromFavorites(device.id);
                    } else {
                        await addToFavorites(device.id);
                    }
                    fetchRecommendations(document.getElementById('searchInput').value); 
                });
                actionsDiv.appendChild(favoriteButton);
            }

            div.insertBefore(actionsDiv, div.firstChild);

            if (device.image) {
                const img = document.createElement('img');
                img.src = device.image;
                img.alt = device.name;
                img.className = 'product-image';
                div.appendChild(img);
            } else {
                const placeholder = document.createElement('div');
                placeholder.className = 'product-image-placeholder';
                placeholder.textContent = 'Fara imagine';
                div.appendChild(placeholder);
            }


            const contentHTML = `
              <h3>${device.name}</h3>
              <p>Preț: ${device.price} Lei</p>
              <p>Caracteristici: ${device.features.join(', ')}</p>
            `;
             const tempDiv = document.createElement('div');
             tempDiv.innerHTML = contentHTML;
             while(tempDiv.firstChild) {
                 div.appendChild(tempDiv.firstChild);
             }

            div.addEventListener('click', (e) => {
                if (!e.target.closest('.device-actions button')) {
                     window.location.href = `/product-details.html?product_id=${device.id}`;
                }
            });
            container.appendChild(div);
          });
      } catch (error) {
           console.error('Error fetching recommendations:', error);
           document.getElementById('recommendations').innerHTML = '<p class="no-results error">Eroare la încarcarea Recomandărilor.</p>';
      }
    }

    let debounceTimer;
    document.getElementById('searchInput').addEventListener('input', () => {

        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            fetchRecommendations(document.getElementById('searchInput').value);
        }, 300); 
    });

    document.querySelectorAll('#filters input[type="number"]').forEach(el => {
      el.addEventListener('input', function() {
          if (this.valueAsNumber < 0) {
              this.value = 0;
          }
           fetchRecommendations(document.getElementById('searchInput').value);
      });
    });

     document.querySelectorAll('#filters select').forEach(el => {
       el.addEventListener('input', function() {
           fetchRecommendations(document.getElementById('searchInput').value);
       });
     });


    //logica de login/inregistrare  
    const loginButton = document.getElementById('loginButton');
    const logoutButton = document.getElementById('logoutButton');
    const loginModal = document.getElementById('loginModal');
    const closeLoginButton = document.querySelector('.login-close-button');
    const loginSubmitButton = document.getElementById('loginSubmit');

    
    const registerModal = document.getElementById('registerModal');
    const closeRegisterButton = document.querySelector('.register-close-button');
    const openRegisterModalButton = document.getElementById('openRegisterModal'); 
    const registerSubmitButton = document.getElementById('registerSubmit');
    const registerUsernameInput = document.getElementById('registerUsername');
    const registerEmailInput = document.getElementById('registerEmail'); 
    const registerPasswordInput = document.getElementById('registerPassword');
    const registerConfirmPasswordInput = document.getElementById('registerConfirmPassword');
    const registerStatusMessageDiv = document.getElementById('registerStatusMessage');

    const loginForm = document.getElementById('loginForm');
    const loginUsernameInput = document.getElementById('loginUsername');
    const loginPasswordInput = document.getElementById('loginPassword');
    const loginStatusMessageDiv = document.getElementById('loginStatusMessage');


    let tokenExpiryCheckInterval;

    loginButton.addEventListener('click', () => {
      loginModal.style.display = 'flex';
      loginStatusMessageDiv.textContent = ''; 
      loginStatusMessageDiv.className = 'status-message';
      loginUsernameInput.value = ''; 
      loginPasswordInput.value = '';
    });

    closeLoginButton.addEventListener('click', () => {
      loginModal.style.display = 'none';
    });

  
    openRegisterModalButton.addEventListener('click', () => {
      loginModal.style.display = 'none'; 
      registerModal.style.display = 'flex'; 
      registerStatusMessageDiv.textContent = ''; 
      registerStatusMessageDiv.className = 'status-message';
      registerUsernameInput.value = '';
      registerEmailInput.value = ''; 
      registerPasswordInput.value = '';
      registerConfirmPasswordInput.value = '';
    });

    
    closeRegisterButton.addEventListener('click', () => {
      registerModal.style.display = 'none';
    });


    window.addEventListener('click', (event) => {
      if (event.target == loginModal) {
        loginModal.style.display = 'none';
      }
      if (event.target == registerModal) { 
        registerModal.style.display = 'none';
      }
    });

    function showLoginStatusMessage(message, type) {
        loginStatusMessageDiv.textContent = message;
        loginStatusMessageDiv.className = `status-message ${type}`;
    }

    function showRegisterStatusMessage(message, type) {
        registerStatusMessageDiv.textContent = message;
        registerStatusMessageDiv.className = `status-message ${type}`;
    }


    function decodeJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        } catch (e) {
            console.error("Failed to decode JWT:", e);
            return null;
        }
    }

    function checkTokenExpiry() {
        const token = localStorage.getItem('token');
        if (token) {
            const decodedToken = decodeJwt(token);
            if (decodedToken && decodedToken.exp) {
                const currentTime = Date.now() / 1000;
                if (decodedToken.exp < currentTime) {
                    console.log("Token expired. Logging out...");
                    logoutUser();
                    return;
                }
            }
        }
        if (!token && tokenExpiryCheckInterval) {
             clearInterval(tokenExpiryCheckInterval);
             tokenExpiryCheckInterval = null;
        }
    }

    function updateAuthUI() {
      const token = localStorage.getItem('token');
      const role = localStorage.getItem('userRole');
      const username = localStorage.getItem('username');
      const addProductButton = document.getElementById('addProductButton');
      const viewFavoritesButton = document.getElementById('viewFavoritesButton');
      const userStatusButton = document.getElementById('userStatusButton');
      const headerTopRightStatusDiv = document.querySelector('.header-top-right-status');

      if (tokenExpiryCheckInterval) {
          clearInterval(tokenExpiryCheckInterval);
          tokenExpiryCheckInterval = null;
      }

      if (token && role && username) {
        // Logged in state
        loginButton.style.display = 'none';
        headerTopRightStatusDiv.style.display = 'flex';
        userStatusButton.style.display = 'block';
        logoutButton.style.display = 'block';
        viewFavoritesButton.style.display = 'block';
        

        userStatusButton.textContent = `${username} (${role})`;


        if (role === 'admin') {
            addProductButton.style.display = 'block';
        } else {
            addProductButton.style.display = 'none';
        }

        tokenExpiryCheckInterval = setInterval(checkTokenExpiry, 5000);
      } else {
        // Logged out state
        loginButton.style.display = 'block';
        headerTopRightStatusDiv.style.display = 'none';
        userStatusButton.style.display = 'none';
        logoutButton.style.display = 'none';
        addProductButton.style.display = 'none';
        viewFavoritesButton.style.display = 'none';
      }
      fetchRecommendations(document.getElementById('searchInput').value);
    }

    loginSubmitButton.addEventListener('click', async (event) => {
      event.preventDefault();
      const username = loginUsernameInput.value; 
      const password = loginPasswordInput.value;

      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ username, password }),
        });

        const data = await response.json();

        if (response.ok) {
          showLoginStatusMessage(data.message, 'success'); 
          localStorage.setItem('token', data.token);
          localStorage.setItem('userRole', data.role);
          localStorage.setItem('username', data.username);
          updateAuthUI();
          setTimeout(() => {
            loginModal.style.display = 'none';
          }, 1500);
        } else {
          showLoginStatusMessage(data.message || 'Eroare la conectare.', 'error'); 
        }
      } catch (error) {
        console.error('Eroare la conectare:', error);
        showLoginStatusMessage('Eroare la conectare. Va rugam sa încercati din nou.', 'error'); 
      }
    });

    registerSubmitButton.addEventListener('click', async (event) => {
      event.preventDefault();
      const username = registerUsernameInput.value; 
      const email = registerEmailInput.value; 
      const password = registerPasswordInput.value;
      // MODIFICAT: Preluat valoarea parolei de confirmare
      const confirmPassword = registerConfirmPasswordInput.value;

      // MODIFICAT: Adaugat validare pentru potrivirea parolelor
      if (password !== confirmPassword) {
          showRegisterStatusMessage('Parolele nu se potrivesc.', 'error');
          return;
      }

      const minLength = 6;
      const hasUppercase = /[A-Z]/.test(password);
      const hasDigit = /\d/.test(password);

      if (!email || !/\S+@\S+\.\S+/.test(email)) { 
        showRegisterStatusMessage('Va rugam sa introduceti o adresa de email valida.', 'error');
        return;
      }

      if (password.length < minLength) {
        showRegisterStatusMessage(`Parola trebuie sa aiba minim ${minLength} caractere.`, 'error');
        return;
      }
      if (!hasUppercase) {
        showRegisterStatusMessage('Parola trebuie sa contina cel putin o litera mare.', 'error');
        return;
      }
      if (!hasDigit) {
        showRegisterStatusMessage('Parola trebuie sa contina cel putin o cifra.', 'error');
        return;
      }

      try {
        
        const response = await fetch('/api/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ username, password, email }),
        });

        const data = await response.json();

        if (response.ok) {
          showRegisterStatusMessage(data.message, 'success'); 
           registerUsernameInput.value = '';
           registerEmailInput.value = ''; 
           registerPasswordInput.value = '';
           // MODIFICAT: Resetat si campul de confirmare
           registerConfirmPasswordInput.value = '';
           
           setTimeout(() => {
               registerModal.style.display = 'none';
               loginModal.style.display = 'flex'; 
               showLoginStatusMessage('Acum va puteti conecta.', 'success');
           }, 1500);

        } else {
          showRegisterStatusMessage(data.message || 'Eroare la înregistrare.', 'error'); 
        }
      } catch (error) {
        console.error('Eroare la înregistrare:', error);
        showRegisterStatusMessage('Eroare la înregistrare. Va rugam sa încercati din nou.', 'error'); 
      }
    });

    function logoutUser() {
      localStorage.removeItem('token');
      localStorage.removeItem('userRole');
      localStorage.removeItem('username');
      if (tokenExpiryCheckInterval) {
          clearInterval(tokenExpiryCheckInterval);
          tokenExpiryCheckInterval = null;
      }
      updateAuthUI();
    }
    logoutButton.addEventListener('click', logoutUser);

    viewFavoritesButton.addEventListener('click', () => {
        window.location.href = '/favorites.html';
    });

    viewStatsButton.addEventListener('click', () => {
        window.location.href = '/stats.html';
    });

    
    viewDocsButton.addEventListener('click', () => {
        window.location.href = '/documentation.html';
    });


    //   Logica Modalului de Adaugare Produs  
    const addProductModal = document.getElementById('addProductModal');
    const closeAddProductButton = document.querySelector('.add-product-close-button');
    const submitProductButton = document.getElementById('submitProduct');
    const productNameInput = document.getElementById('productNameInput');
    const productPriceInput = document.getElementById('productPriceInput');
    const productBatteryLifeInput = document.getElementById('productBatteryLifeInput');
    const productTypeInput = document.getElementById('productTypeInput');
    const productFeaturesInput = document.getElementById('productFeaturesInput');
    const productLinkInput = document.getElementById('productLinkInput');
    const productImageInput = document.getElementById('productImageInput');
    const addProductStatusMessageDiv = document.getElementById('addProductStatusMessage');

    document.getElementById('addProductButton').addEventListener('click', () => {
      addProductModal.style.display = 'flex';
      addProductStatusMessageDiv.textContent = '';
      addProductStatusMessageDiv.className = 'status-message'; 
      document.getElementById('productForm').reset();
    });

    closeAddProductButton.addEventListener('click', () => {
      addProductModal.style.display = 'none';
    });

    window.addEventListener('click', (event) => {
      if (event.target == addProductModal) {
        addProductModal.style.display = 'none';
      }
    });

    function showAddProductStatusMessage(message, type) {
        addProductStatusMessageDiv.textContent = message;
        addProductStatusMessageDiv.className = `status-message ${type}`; 
    }

    submitProductButton.addEventListener('click', async (event) => {
        event.preventDefault();

        const name = productNameInput.value.trim();
        const price = parseFloat(productPriceInput.value);
        const batteryLife = productBatteryLifeInput.value ? parseInt(productBatteryLifeInput.value, 10) : null;
        const type = productTypeInput.value;
        const features = productFeaturesInput.value.split(',').map(f => f.trim()).filter(f => f.length > 0);
        const link = productLinkInput.value.trim();
        const image = productImageInput.value.trim();

        if (!name || isNaN(price) || price <= 0 || !type || features.length === 0) {
            showAddProductStatusMessage('Va rugam sa completati toate campurile obligatorii: Nume, Preț valid (>0), Tip si cel putin o Caracteristica.', 'error');
            return;
        }

        const token = localStorage.getItem('token');
        if (!token) {
            showAddProductStatusMessage('Nu sunteti autentificat. Va rugam sa va conectati ca administrator.', 'error');
            return;
        }

        try {
            const response = await fetch('/api/products', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ name, price, batteryLife, type, features, link, image })
            });

            const data = await response.json();

            if (response.ok) {
                showAddProductStatusMessage(data.message, 'success');
                document.getElementById('productForm').reset();
                updateAuthUI(); 
                setTimeout(() => {
                    addProductModal.style.display = 'none';
                }, 1500);
            } else {
                showAddProductStatusMessage(data.message || 'Eroare la adăugarea produsului.', 'error');
            }
        } catch (error) {
            console.error('Eroare la adăugarea produsului:', error);
            showAddProductStatusMessage('A aparut o eroare la trimiterea datelor. Va rugam sa încercati din nou.', 'error');
        }
    });

    //Logica Modalului de Editare Produs  
    const editProductModal = document.getElementById('editProductModal');
    const closeEditProductButton = document.querySelector('.edit-product-close-button');
    const updateProductButton = document.getElementById('updateProduct');
    const editProductIdInput = document.getElementById('editProductId');
    const editProductNameInput = document.getElementById('editProductNameInput');
    const editProductPriceInput = document.getElementById('editProductPriceInput');
    const editProductBatteryLifeInput = document.getElementById('editProductBatteryLifeInput');
    const editProductTypeInput = document.getElementById('editProductTypeInput');
    const editProductFeaturesInput = document.getElementById('editProductFeaturesInput');
    const editProductLinkInput = document.getElementById('editProductLinkInput');
    const editProductImageInput = document.getElementById('editProductImageInput');
    const editProductStatusMessageDiv = document.getElementById('editProductStatusMessage');

    function showEditProductStatusMessage(message, type) {
        editProductStatusMessageDiv.textContent = message;
        editProductStatusMessageDiv.className = `status-message ${type}`;
    }

    async function openEditProductModal(productId) {
        editProductStatusMessageDiv.textContent = '';
        editProductStatusMessageDiv.className = 'status-message'; 

        try {
            const userRole = localStorage.getItem('userRole');
            const token = localStorage.getItem('token');
            if (userRole !== 'admin' || !token) {
                 alert('Nu aveti permisiunea de a edita produse.');
                 return;
            }

            const res = await fetch(`/api/products/${productId}`, {
                 headers: {
                    'Authorization': `Bearer ${token}`
                 }
            });
            const product = await res.json();

            if (res.ok) {
                editProductIdInput.value = product.id;
                editProductNameInput.value = product.name;
                editProductPriceInput.value = product.price;
                editProductBatteryLifeInput.value = product.batterylife || '';
                editProductTypeInput.value = product.type;
                editProductFeaturesInput.value = product.features.join(', ');
                editProductLinkInput.value = product.link && product.link !== 'null' ? product.link : '';
                editProductImageInput.value = product.image && product.image !== 'null' ? product.image : '';

                editProductModal.style.display = 'flex';
            } else {
                showEditProductStatusMessage(product.message || `Eroare la preluarea datelor produsului (Status: ${res.status}).`, 'error');
                 editProductModal.style.display = 'none';
            }
        } catch (error) {
            console.error('Error fetching product for edit:', error);
            showEditProductStatusMessage('A parut o eroare la încarcarea datelor produsului pentru editare. Verificati conexiunea si autentificarea.', 'error');
             editProductModal.style.display = 'none';
        }
    }

    closeEditProductButton.addEventListener('click', () => {
      editProductModal.style.display = 'none';
    });

    window.addEventListener('click', (event) => {
      if (event.target == editProductModal) {
        editProductModal.style.display = 'none';
      }
    });

    updateProductButton.addEventListener('click', async (event) => {
        event.preventDefault();

        const productId = editProductIdInput.value;
        const name = editProductNameInput.value.trim();
        const price = parseFloat(editProductPriceInput.value);
        const batteryLife = editProductBatteryLifeInput.value ? parseInt(editProductBatteryLifeInput.value, 10) : null;
        const type = editProductTypeInput.value;
        const features = editProductFeaturesInput.value.split(',').map(f => f.trim()).filter(f => f.length > 0);
        const link = editProductLinkInput.value.trim();
        const image = editProductImageInput.value.trim();

         if (!productId || !name || isNaN(price) || price <= 0 || !type || features.length === 0) {
            showEditProductStatusMessage('Va rugam sa completati toate campurile obligatorii: Nume, Preț valid (>0), Tip si cel putin o Caracteristica.', 'error');
            return;
        }

        const token = localStorage.getItem('token');
        if (!token) {
            showEditProductStatusMessage('Nu sunteti autentificat. Va rugam sa va conectati ca administrator.', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/products/${productId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ name, price, batteryLife, type, features, link, image })
            });

            const data = await response.json();

            if (response.ok) {
                showEditProductStatusMessage(data.message, 'success');
                updateAuthUI();
                setTimeout(() => {
                    editProductModal.style.display = 'none';
                }, 1500);
            } else {
                showEditProductStatusMessage(data.message || `Eroare la actualizarea produsului (Status: ${response.status}).`, 'error');
            }
        } catch (error) {
            console.error('Eroare la actualizarea produsului:', error);
            showEditProductStatusMessage('A parut o eroare la trimiterea datelor de actualizare. Verificati conexiunea si autentificarea.', 'error');
        }
    });

    async function deleteProduct(productId) {
        const token = localStorage.getItem('token');
        const userRole = localStorage.getItem('userRole');

        if (userRole !== 'admin' || !token) {
            alert('Nu aveti permisiunea de a șterge produse. Va rugam sa va conectati ca administrator.');
            return;
        }

        if (!confirm('Esti sigur ca vrei sa stergi acest produs?')) {
             return;
        }

        try {
            const response = await fetch(`/api/products/${productId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const data = await response.json();

            if (response.ok) {
                alert(data.message);
                updateAuthUI();
            } else {
                alert(data.message || `Eroare la ștergerea produsului (Status: ${response.status}).`);
            }
        } catch (error) {
            console.error('Eroare la ștergerea produsului:', error);
            alert('A parut o eroare la ștergerea produsului. Verificati conexiunea si autentificarea.');
        }
    }

    async function addToFavorites(productId) {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('Trebuie sa fii autentificat pentru a adaugă produse la favorite.');
            return;
        }
        try {
            const response = await fetch('/api/favorites', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ productId })
            });
            const data = await response.json();
            if (response.ok) {
            } else {
                alert(data.message || 'Eroare la adăugarea la favorite.');
            }
        } catch (error) {
            console.error('Eroare la adăugarea la favorite:', error);
            alert('A parut o eroare de retea la adăugarea la favorite.');
        }
    }

    async function removeFromFavorites(productId) {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('Trebuie sa fii autentificat pentru a elimină produse din favorite.');
            return;
        }
        try {
            const response = await fetch(`/api/favorites/${productId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            if (response.ok) {
            } else {
                alert(data.message || 'Eroare la eliminarea din favorite.');
            }
        } catch (error) {
            console.error('Eroare la eliminarea din favorite:', error);
            alert('A parut o eroare de retea la eliminarea din favorite.');
        }
    }


    function initializePage() {
        updateAuthUI();
        document.querySelectorAll('.toggle-password').forEach(button => {
            button.addEventListener('click', () => {
                const passwordInput = button.parentElement.querySelector('input');
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                
                button.textContent = type === 'password' ? 'Arată' : 'Ascunde';
            });
        });
    }

    document.addEventListener('DOMContentLoaded', initializePage);

    window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
            console.log("Pagina a fost restaurată din cache. Se reîmprospătează datele.");
            updateAuthUI();
        }
    });
  </script>
</body>
</html>