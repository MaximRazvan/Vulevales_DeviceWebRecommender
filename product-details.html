<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" >
  <meta name="viewport" content="width=device-width, initial-scale=1.0" >
  <title id="pageTitle">Detalii Produs - Recomandări Dispozitive Electronice</title>
  <link rel="icon" href="ico.jpg" type="image/jpeg">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="product-details.css"> </head>
<body>
  <header>
     <a href="/">
        <h1>Recomandări Dispozitive Electronice</h1>
     </a>
  </header>

  <main>
    <section id="productDetails">
      <button id="backToRecommendations">Înapoi la Recomandări</button>
      <div class="product-actions">
          <button id="favoriteButton" class="action-btn favorite-btn" style="display: none;">Adaugă la Favorite</button>
          <button id="editProductButton" class="action-btn edit-btn" style="display: none;">Editează Produs</button>
          <button id="deleteProductButton" class="action-btn delete-btn" style="display: none;">Șterge Produs</button>
      </div>
      <h2 id="productName">Încarcare...</h2>
      <p class="loading-message">Se încarca detaliile produsului...</p>
    </section>
  </main>

  <footer>
    <div class="rss-box">
        <a href="/rss">RSS Feed</a>
    </div>
  </footer>

  <div id="editProductModal" class="modal">
      <div class="modal-content">
          <span class="close-button edit-product-close-button">×</span>
          <h2>Editează Produs</h2>
          <form id="editProductForm">
              <input type="hidden" id="editProductId">

              <label for="editProductNameInput">Nume Produs:</label>
              <input type="text" id="editProductNameInput" required>

              <label for="editProductPriceInput">Preț:</label>
              <input type="number" id="editProductPriceInput" step="0.01" required min="0">

              <label for="editProductBatteryLifeInput">Autonomie Baterie (ore):</label>
              <input type="number" id="editProductBatteryLifeInput" min="0">

              <label for="editProductTypeInput">Tip Produs:</label>
              <select id="editProductTypeInput" required>
                  <option value="">Selecteaza un tip</option>
                  <option value="telefon">Telefon</option>
                  <option value="tableta">Tableta</option>
                  <option value="ceas">Ceas</option>
                  <option value="drona">Drona</option>
                  <option value="laptop">Laptop</option>
                  <option value="casti">Casti</option>
              </select>

              <label for="editProductFeaturesInput">Caracteristici (separate prin virgula):</label>
              <input type="text" id="editProductFeaturesInput" placeholder="Ex: 5G, iOS, Face ID" required>

              <label for="editProductLinkInput">Link Produs (optional):</label>
              <input type="url" id="editProductLinkInput" placeholder="Ex: https://exemplu.com/produs">

              <label for="editProductImageInput">URL Imagine Produs (optional):</label>
              <input type="url" id="editProductImageInput" placeholder="Ex: https://exemplu.com/imagine.jpg">

              <div class="modal-buttons">
                  <button type="submit" id="updateProduct">Actualizeaza Produs</button>
              </div>
          </form>
          <div id="editProductStatusMessage"></div>
      </div>
  </div>


  <script>
    const productDetailsSection = document.getElementById('productDetails');
    const backToRecommendationsButton = document.getElementById('backToRecommendations');
    const productNameElement = document.getElementById('productName');
    const loadingMessageElement = productDetailsSection.querySelector('.loading-message');

    // Referinte la butoanele de actiune
    const favoriteButton = document.getElementById('favoriteButton');
    const editProductButton = document.getElementById('editProductButton');
    const deleteProductButton = document.getElementById('deleteProductButton');
    let currentProductId = null;

    const editProductModal = document.getElementById('editProductModal');
    const closeEditProductButton = document.querySelector('.edit-product-close-button');
    const updateProductButton = document.getElementById('updateProduct');
    const editProductIdInput = document.getElementById('editProductId');
    const editProductNameInput = document.getElementById('editProductNameInput');
    const editProductPriceInput = document.getElementById('editProductPriceInput');
    const editProductBatteryLifeInput = document.getElementById('editProductBatteryLifeInput');
    const editProductTypeInput = document.getElementById('editProductTypeInput');
    const editProductFeaturesInput = document.getElementById('editProductFeaturesInput');
    const editProductLinkInput = document.getElementById('editProductLinkInput');
    const editProductImageInput = document.getElementById('editProductImageInput');
    const editProductStatusMessageDiv = document.getElementById('editProductStatusMessage');

    // Functie pentru decodarea JWT
    function decodeJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        } catch (e) {
            console.error("Failed to decode JWT:", e);
            return null;
        }
    }

    // Functie pentru a actualiza vizibilitatea butoanelor si starea butonului de favorite
    async function updateUIForUserRoleAndFavorites(productId) {
        const token = localStorage.getItem('token');
        const userRole = localStorage.getItem('userRole');

        favoriteButton.style.display = 'none';
        editProductButton.style.display = 'none';
        deleteProductButton.style.display = 'none';

        if (token) {
            // Afiseaza butonul de favorite si verifica starea
            favoriteButton.style.display = 'block';
            const isFavorited = await checkFavoriteStatus(productId);
            if (isFavorited) {
                favoriteButton.textContent = 'Elimină din Favorite';
                favoriteButton.classList.add('favorited');
            } else {
                favoriteButton.textContent = 'Adaugă la Favorite';
                favoriteButton.classList.remove('favorited');
            }

            if (userRole === 'admin') {
                editProductButton.style.display = 'block';
                deleteProductButton.style.display = 'block';
            }
        }
    }

    // Functii pentru Favorite
    async function checkFavoriteStatus(productId) {
        const token = localStorage.getItem('token');
        if (!token) return false;
        try {
            const res = await fetch(`/api/favorites/check/${productId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
                const data = await res.json();
                return data.isFavorited;
            }
            return false;
        } catch (error) {
            console.error('Eroare la verificare stare favorite:', error);
            return false;
        }
    }

    async function addToFavorites(productId) {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('Trebuie sa fii autentificat pentru a adaugă produse la favorite.');
            return false; // Return false on failure
        }
        try {
            const response = await fetch('/api/favorites', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ productId })
            });
            const data = await response.json();
            if (response.ok) {
                return true; 
            } else {
                alert(data.message || 'Eroare la adăugarea la favorite.');
                return false;
            }
        } catch (error) {
            console.error('Eroare la adăugarea la favorite:', error);
            alert('A aparut o eroare de retea la adăugarea la favorite.');
            return false;
        }
    }

    async function removeFromFavorites(productId) {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('Trebuie sa fii autentificat pentru a elimină produse din favorite.');
            return false; 
        }
        try {
            const response = await fetch(`/api/favorites/${productId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            if (response.ok) {
                
                return true; 
            } else {
                alert(data.message || 'Eroare la eliminarea din favorite.');
                return false;
            }
        } catch (error) {
            console.error('Eroare la eliminarea din favorite:', error);
            alert('A aparut o eroare de retea la eliminarea din favorite.');
            return false;
        }
    }

    // Functii pentru Editare/stergere 
    function showEditProductStatusMessage(message, type) {
        editProductStatusMessageDiv.textContent = message;
        editProductStatusMessageDiv.className = type;
    }

    async function openEditProductModal(productId) {
        editProductStatusMessageDiv.textContent = '';
        editProductStatusMessageDiv.className = '';

        try {
            const userRole = localStorage.getItem('userRole');
            const token = localStorage.getItem('token');
            if (userRole !== 'admin' || !token) {
                 alert('Nu aveti permisiunea de a edita produse.');
                 return;
            }

            const res = await fetch(`/api/products/${productId}`, {
                 headers: {
                    'Authorization': `Bearer ${token}`
                 }
            });
            const product = await res.json();

            if (res.ok) {
                editProductIdInput.value = product.id;
                editProductNameInput.value = product.name;
                editProductPriceInput.value = product.price;
                editProductBatteryLifeInput.value = product.batterylife || '';
                editProductTypeInput.value = product.type;
                editProductFeaturesInput.value = product.features.join(', ');
                editProductLinkInput.value = product.link && product.link !== 'null' ? product.link : '';
                editProductImageInput.value = product.image && product.image !== 'null' ? product.image : '';

                editProductModal.style.display = 'flex';
            } else {
                showEditProductStatusMessage(product.message || `Eroare la preluarea datelor produsului (Status: ${res.status}).`, 'error');
                 editProductModal.style.display = 'none';
            }
        } catch (error) {
            console.error('Error fetching product for edit:', error);
            showEditProductStatusMessage('A aparut o eroare la încarcarea datelor produsului pentru editare. Verificati conexiunea si autentificarea.', 'error');
             editProductModal.style.display = 'none';
        }
    }

    async function deleteProduct(productId) {
        const token = localStorage.getItem('token');
        const userRole = localStorage.getItem('userRole');

        if (userRole !== 'admin' || !token) {
            alert('Nu aveti permisiunea de a șterge produse. Va rugam sa va conectati ca administrator.');
            return;
        }

        if (!confirm('Esti sigur ca vrei sa stergi acest produs? Aceasta actiune este ireversibila!')) {
             return;
        }

        try {
            const response = await fetch(`/api/products/${productId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const data = await response.json();

            if (response.ok) {
                alert(data.message);
                window.location.href = '/'; // Redirectioneaza înapoi la pagina principala dupa stergere
            } else {
                alert(data.message || `Eroare la ștergerea produsului (Status: ${response.status}).`);
            }
        } catch (error) {
            console.error('Eroare la ștergerea produsului:', error);
            alert('A aparut o eroare la ștergerea produsului. Verificati conexiunea si autentificarea.');
        }
    }


    // Functie pentru a afisa detaliile produsului
    async function displayProductDetails(productId) {
        productNameElement.textContent = 'Încarcare...';
        loadingMessageElement.style.display = 'block';
        const existingDetails = productDetailsSection.querySelectorAll('p:not(.loading-message), a, img, .product-stats');
        existingDetails.forEach(el => el.remove());


        try {
            const res = await fetch(`/api/products/${productId}`);
            const product = await res.json();

            loadingMessageElement.style.display = 'none';

            if (res.ok) {
                document.getElementById('pageTitle').textContent = `${product.name} - Recomandări Dispozitive Electronice`;
                productNameElement.textContent = product.name;

                // Set currentProductId after successful fetch
                currentProductId = productId;
                // Update UI for action buttons based on user role and favorite status
                await updateUIForUserRoleAndFavorites(productId);

               
                const statsContainer = document.createElement('div');
                statsContainer.className = 'product-stats';

                const likesSpan = document.createElement('span');
                likesSpan.className = 'stat-item';
                
                likesSpan.innerHTML = `👍 ${product.likes_count} Aprecieri`;

                const viewsSpan = document.createElement('span');
                viewsSpan.className = 'stat-item';
                
                viewsSpan.innerHTML = `👁️ ${product.views_count + 1} Vizualizări`;

                statsContainer.appendChild(likesSpan);
                statsContainer.appendChild(viewsSpan);
                
                productNameElement.after(statsContainer);

               
                if (product.image) {
                    const img = document.createElement('img');
                    img.src = product.image;
                    img.alt = product.name;
                    img.className = 'detail-product-image';
                    statsContainer.after(img);
                }

                
                const pricePara = document.createElement('p');
                pricePara.innerHTML = `<strong>Preț:</strong> <span id="productPrice">${product.price}</span> Lei`;
                
                const batteryPara = document.createElement('p');
                batteryPara.innerHTML = `<strong>Autonomie baterie:</strong> <span id="productBatteryLife">${product.batterylife ? `${product.batterylife} ore` : 'N/A'}</span>`;
                
                const typePara = document.createElement('p');
                typePara.innerHTML = `<strong>Tip:</strong> <span id="productType">${product.type}</span>`;
                
                const featuresPara = document.createElement('p');
                featuresPara.innerHTML = `<strong>Caracteristici:</strong> <span id="productFeatures">${product.features.join(', ')}</span>`;
                
                const lastAppendedElement = productDetailsSection.querySelector('img.detail-product-image') || statsContainer;
                lastAppendedElement.after(pricePara, batteryPara, typePara, featuresPara);

                // Adaugam link-ul la final
                if (product.link && product.link !== 'null' && product.link.trim() !== '') {
                    const linkPara = document.createElement('p');
                    const linkLabel = document.createElement('strong');
                    linkLabel.textContent = 'Link: ';
                    
                    const productLinkElement = document.createElement('a');
                    productLinkElement.href = product.link;
                    productLinkElement.textContent = 'Vizitează pagina produsului';
                    productLinkElement.target = '_blank';
                    
                    linkPara.appendChild(linkLabel);
                    linkPara.appendChild(productLinkElement);
                    featuresPara.after(linkPara);
                }


            } else {
                productNameElement.textContent = 'Eroare';
                const errorMessage = document.createElement('p');
                errorMessage.className = 'error-message';
                errorMessage.textContent = `Eroare la încarcarea produsului: ${product.message || `Produsul cu ID ${productId} nu a fost gasit.`}`;
                productDetailsSection.appendChild(errorMessage);
                document.getElementById('pageTitle').textContent = `Eroare - Recomandări Dispozitive Electronice`;
            }
        } catch (error) {
            console.error('Eroare la preluarea detaliilor produsului:', error);
            loadingMessageElement.style.display = 'none';
            productNameElement.textContent = 'Eroare';
            const errorMessage = document.createElement('p');
            errorMessage.className = 'error-message';
            errorMessage.textContent = 'A aparut o eroare la încarcarea detaliilor produsului. Verificati conexiunea.';
            productDetailsSection.appendChild(errorMessage);
            document.getElementById('pageTitle').textContent = `Eroare - Recomandări Dispozitive Electronice`;

        }
    }

    // Event listener pentru butonul "Înapoi la Recomandări"
    backToRecommendationsButton.addEventListener('click', () => {
        window.location.href = '/';
    });

    favoriteButton.addEventListener('click', async () => {
        if (!currentProductId) return;
        const isFavorited = favoriteButton.classList.contains('favorited');
        let success;
        if (isFavorited) {
            success = await removeFromFavorites(currentProductId);
        } else {
            success = await addToFavorites(currentProductId);
        }
        if (success) {
            await updateUIForUserRoleAndFavorites(currentProductId); // refresh
        }
    });

    editProductButton.addEventListener('click', () => {
        if (currentProductId) {
            openEditProductModal(currentProductId);
        }
    });

    deleteProductButton.addEventListener('click', () => {
        if (currentProductId) {
            deleteProduct(currentProductId);
        }
    });

    // Event listeners pentru modalul de editare
    closeEditProductButton.addEventListener('click', () => {
      editProductModal.style.display = 'none';
    });

    window.addEventListener('click', (event) => {
      if (event.target == editProductModal) {
        editProductModal.style.display = 'none';
      }
    });

    updateProductButton.addEventListener('click', async (event) => {
        event.preventDefault();

        const productId = editProductIdInput.value;
        const name = editProductNameInput.value.trim();
        const price = parseFloat(editProductPriceInput.value);
        const batteryLife = editProductBatteryLifeInput.value ? parseInt(editProductBatteryLifeInput.value, 10) : null;
        const type = editProductTypeInput.value;
        const features = editProductFeaturesInput.value.split(',').map(f => f.trim()).filter(f => f.length > 0);
        const link = editProductLinkInput.value.trim();
        const image = editProductImageInput.value.trim();

         if (!productId || !name || isNaN(price) || price <= 0 || !type || features.length === 0) {
            showEditProductStatusMessage('Va rugam sa completati toate campurile obligatorii: Nume, Preț valid (>0), Tip si cel putin o Caracteristica.', 'error');
            return;
        }

        const token = localStorage.getItem('token');
        if (!token) {
            showEditProductStatusMessage('Nu sunteti autentificat. Va rugam sa va conectati ca administrator.', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/products/${productId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ name, price, batteryLife, type, features, link, image })
            });

            const data = await response.json();

            if (response.ok) {
                showEditProductStatusMessage(data.message, 'success');
                
                await displayProductDetails(currentProductId);
                setTimeout(() => {
                    editProductModal.style.display = 'none';
                }, 1500);
            } else {
                showEditProductStatusMessage(data.message || `Eroare la actualizarea produsului (Status: ${response.status}).`, 'error');
            }
        } catch (error) {
            console.error('Eroare la actualizarea produsului:', error);
            showEditProductStatusMessage('A aparut o eroare la trimiterea datelor de actualizare. Verificati conexiunea si autentificarea.', 'error');
        }
    });


    // încarcarea paginii de detalii
    function handleProductDetailsPageLoad() {
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('product_id');

        if (productId) {
            displayProductDetails(productId);
        } else {
            productNameElement.textContent = 'Eroare';
            loadingMessageElement.style.display = 'none';
            const errorMessage = document.createElement('p');
            errorMessage.className = 'error-message';
            errorMessage.textContent = 'ID-ul produsului nu a fost specificat în adresa.';
            productDetailsSection.appendChild(errorMessage);
            document.getElementById('pageTitle').textContent = `Eroare - Recomandări Dispozitive Electronice`;
        }
    }

    
    document.addEventListener('DOMContentLoaded', handleProductDetailsPageLoad);
  </script>
</body>
</html>