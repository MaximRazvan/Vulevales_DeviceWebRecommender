<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recomandări Dispozitive Electronice</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }

    header {
      background-color: #282c34;
      padding: 1em;
      color: white;
      text-align: center;
      position: relative;
    }

    #authStatus {
      position: absolute;
      top: 1em;
      right: 1em;
      color: white;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #loginButton, #logoutButton, #addProductButton {
      background-color: #4CAF50;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      transition: background-color 0.3s ease;
    }

    #loginButton:hover, #logoutButton:hover, #addProductButton:hover {
      background-color: #45a049;
    }

    #logoutButton {
        background-color: #f44336;
    }

    #logoutButton:hover {
        background-color: #da190b;
    }

    #addProductButton {
        background-color: #007bff; /* Blue color for add product button */
        position: absolute;
        top: 1em;
        left: 1em;
    }

    #addProductButton:hover {
        background-color: #0056b3;
    }


    /* Stiluri pentru Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      position: relative;
    }

    .close-button {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      position: absolute;
      top: 10px;
      right: 15px;
    }

    .close-button:hover,
    .close-button:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

    .modal-content h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }

    .modal-content form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .modal-content label {
      font-weight: bold;
      color: #555;
    }

    .modal-content input[type="text"],
    .modal-content input[type="password"],
    .modal-content input[type="number"],
    .modal-content select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1em;
    }

    .modal-buttons {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }

    .modal-buttons button {
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      transition: background-color 0.3s ease;
    }

    .modal-buttons button:hover {
      background-color: #0056b3;
    }

    #statusMessage {
      text-align: center;
      margin-top: 10px;
      font-weight: bold;
    }

    #statusMessage.success {
      color: green;
    }

    #statusMessage.error {
      color: red;
    }

    #filters {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1em;
      margin: 1em;
    }

    #filters input, #filters select {
      padding: 0.5em;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    main {
      padding: 1em;
    }

    section {
      margin-bottom: 2em;
    }

    .device-card {
      background-color: white;
      padding: 1em;
      border-radius: 8px;
      margin-bottom: 1em;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      position: relative; /* Added for positioning edit/delete buttons */
    }

    .device-card:hover {
        background-color: #e9e9e9;
    }

    .device-actions {
        position: absolute;
        top: 10px;
        right: 10px;
        display: none; /* Hidden by default, shown for admin */
        gap: 5px;
    }

    .device-card:hover .device-actions {
        display: flex; /* Show on hover for admin if admin is logged in */
    }

    .device-actions button {
        background-color: #28a745; /* Green for edit */
        color: white;
        border: none;
        padding: 5px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8em;
        transition: background-color 0.2s ease;
    }

    .device-actions button.delete-btn {
        background-color: #dc3545; /* Red for delete */
    }

    .device-actions button:hover {
        opacity: 0.9;
    }


    .no-results {
      text-align: center;
      font-style: italic;
      color: #666;
      margin-top: 2em;
    }

    /* Stiluri pentru Pagina Produsului */
    #productDetails {
        background-color: white;
        padding: 2em;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        max-width: 800px;
        margin: 2em auto;
        display: none;
    }

    #productDetails h2 {
        text-align: center;
        color: #333;
        margin-bottom: 1em;
    }

    #productDetails p {
        margin-bottom: 0.5em;
        line-height: 1.6;
    }

    #productDetails a {
        color: #007bff;
        text-decoration: none;
    }

    #productDetails a:hover {
        text-decoration: underline;
    }

    #backToRecommendations {
        background-color: #6c757d;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
        margin-top: 1em;
        display: block;
        width: fit-content;
        margin-left: auto;
        margin-right: auto;
    }

    #backToRecommendations:hover {
        background-color: #5a6268;
    }

    footer {
      background-color: #282c34;
      color: white;
      text-align: center;
      padding: 1em;
    }
  </style>
</head>
<body>
  <header>
    <h1>Recomandări Dispozitive Electronice</h1>
    <button id="addProductButton" style="display: none;">Adaugă Produs</button>
    <button id="loginButton">Conectare/Înregistrare</button>
    <div id="authStatus" style="display: none;">
        <span id="welcomeMessage"></span>
        <button id="logoutButton" style="display: none;">Deconectare</button>
    </div>
    <input type="text" id="searchInput" placeholder="Caută după model sau caracteristici...">
    <div id="filters">
      <input type="number" id="minPrice" placeholder="Preț minim">
      <input type="number" id="maxPrice" placeholder="Preț maxim">
      <input type="number" id="batteryLife" placeholder="Autonomie (ore)">
      <select id="deviceType">
        <option value="">Toate tipurile</option>
        <option value="telefon">Telefon</option>
        <option value="tableta">Tabletă</option>
        <option value="ceas">Ceas</option>
        <option value="drona">Dronă</option>
      </select>
    </div>
  </header>

  <main>
    <section id="recommendationsList">
        <div id="recommendations"></div>
    </section>
    
    <section id="popularStats">
      <h2>Statistici populare</h2>
      <ul id="popularList"></ul>
    </section>

    <!-- Product Detail Section -->
    <section id="productDetails" style="display: none;">
      <button id="backToRecommendations">Înapoi la Recomandări</button>
      <h2 id="productName"></h2>
      <p><strong>Preț:</strong> <span id="productPrice"></span> Lei</p>
      <p><strong>Autonomie baterie:</strong> <span id="productBatteryLife"></span> ore</p>
      <p><strong>Tip:</strong> <span id="productType"></span></p>
      <p><strong>Caracteristici:</strong> <span id="productFeatures"></span></p>
      <p><strong>Link:</strong> <a id="productLink" href="#" target="_blank">Vizitează pagina produsului</a></p>
    </section>
  </main>

  <footer>
    <a href="/rss">RSS Feed</a>
  </footer>

  <!-- Login/Register Modal -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <span class="close-button login-close-button">&times;</span>
      <h2>Conectare sau Înregistrare</h2>
      <form id="authForm">
        <label for="username">Nume utilizator:</label>
        <input type="text" id="username" name="username" required>

        <label for="password">Parolă:</label>
        <input type="password" id="password" name="password" required>
        
        <div class="modal-buttons">
          <button type="button" id="loginSubmit">Conectare</button>
          <button type="button" id="registerSubmit">Înregistrare</button>
        </div>
      </form>
      <div id="statusMessage"></div>
    </div>
  </div>

  <!-- Add Product Modal -->
  <div id="addProductModal" class="modal">
    <div class="modal-content">
      <span class="close-button add-product-close-button">&times;</span>
      <h2>Adaugă Produs Nou</h2>
      <form id="productForm">
        <label for="productNameInput">Nume Produs:</label>
        <input type="text" id="productNameInput" required>

        <label for="productPriceInput">Preț:</label>
        <input type="number" id="productPriceInput" step="0.01" required>

        <label for="productBatteryLifeInput">Autonomie Baterie (ore):</label>
        <input type="number" id="productBatteryLifeInput">

        <label for="productTypeInput">Tip Produs:</label>
        <select id="productTypeInput" required>
            <option value="">Selectează un tip</option>
            <option value="telefon">Telefon</option>
            <option value="tableta">Tabletă</option>
            <option value="ceas">Ceas</option>
            <option value="drona">Dronă</option>
            <option value="laptop">Laptop</option>
            <option value="casti">Căști</option>
        </select>

        <label for="productFeaturesInput">Caracteristici (separate prin virgulă):</label>
        <input type="text" id="productFeaturesInput" placeholder="Ex: 5G, iOS, Face ID" required>

        <label for="productLinkInput">Link Produs (opțional):</label>
        <input type="url" id="productLinkInput" placeholder="Ex: https://exemplu.com/produs">

        <div class="modal-buttons">
          <button type="submit" id="submitProduct">Adaugă Produs</button>
        </div>
      </form>
      <div id="addProductStatusMessage"></div>
    </div>
  </div>

    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <span class="close-button edit-product-close-button">&times;</span>
            <h2>Editează Produs</h2>
            <form id="editProductForm">
                <input type="hidden" id="editProductId">
                <label for="editProductNameInput">Nume Produs:</label>
                <input type="text" id="editProductNameInput" required>

                <label for="editProductPriceInput">Preț:</label>
                <input type="number" id="editProductPriceInput" step="0.01" required>

                <label for="editProductBatteryLifeInput">Autonomie Baterie (ore):</label>
                <input type="number" id="editProductBatteryLifeInput">

                <label for="editProductTypeInput">Tip Produs:</label>
                <select id="editProductTypeInput" required>
                    <option value="">Selectează un tip</option>
                    <option value="telefon">Telefon</option>
                    <option value="tableta">Tabletă</option>
                    <option value="ceas">Ceas</option>
                    <option value="drona">Dronă</option>
                    <option value="laptop">Laptop</option>
                    <option value="casti">Căști</option>
                </select>

                <label for="editProductFeaturesInput">Caracteristici (separate prin virgulă):</label>
                <input type="text" id="editProductFeaturesInput" placeholder="Ex: 5G, iOS, Face ID" required>

                <label for="editProductLinkInput">Link Produs (opțional):</label>
                <input type="url" id="editProductLinkInput" placeholder="Ex: https://exemplu.com/produs">

                <div class="modal-buttons">
                    <button type="submit" id="updateProduct">Actualizează Produs</button>
                </div>
            </form>
            <div id="editProductStatusMessage"></div>
        </div>
    </div>


  <script>
    const recommendationsListSection = document.getElementById('recommendationsList');
    const popularStatsSection = document.getElementById('popularStats');
    const productDetailsSection = document.getElementById('productDetails');
    const backToRecommendationsButton = document.getElementById('backToRecommendations');

    // Function to show/hide sections
    function showSection(sectionElement) {
        recommendationsListSection.style.display = 'none';
        popularStatsSection.style.display = 'none';
        productDetailsSection.style.display = 'none';
        sectionElement.style.display = 'block';
    }

    async function fetchRecommendations(query = '') {
      const minPrice = document.getElementById('minPrice').value;
      const maxPrice = document.getElementById('maxPrice').value;
      const batteryLife = document.getElementById('batteryLife').value;
      const deviceType = document.getElementById('deviceType').value;
      const userRole = localStorage.getItem('userRole'); // Get user role

      const params = new URLSearchParams({
        q: query,
        minPrice,
        maxPrice,
        batteryLife,
        deviceType
      });

      const res = await fetch(`/api/recommendations?${params.toString()}`);
      const data = await res.json();
      const container = document.getElementById('recommendations');
      container.innerHTML = '';
      
      if (data.length === 0) {
        container.innerHTML = '<p class="no-results">Nu s-au găsit recomandări.</p>';
        return;
      }
      data.forEach(device => {
        const div = document.createElement('div');
        div.className = 'device-card';
        div.dataset.productId = device.id;
        div.innerHTML = `
          <h3>${device.name}</h3>
          <p>Preț: ${device.price} Lei</p>
          <p>Caracteristici: ${device.features.join(', ')}</p>
        `;

        // Add edit/delete buttons if user is admin
        if (userRole === 'admin') {
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'device-actions';

            const editButton = document.createElement('button');
            editButton.textContent = 'Editează';
            editButton.className = 'edit-btn';
            editButton.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent card click from triggering
                openEditProductModal(device.id);
            });

            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Șterge';
            deleteButton.className = 'delete-btn';
            deleteButton.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent card click from triggering
                if (confirm('Ești sigur că vrei să ștergi acest produs?')) {
                    deleteProduct(device.id);
                }
            });

            actionsDiv.appendChild(editButton);
            actionsDiv.appendChild(deleteButton);
            div.appendChild(actionsDiv);
        }

        // Original click event for product details
        div.addEventListener('click', () => {
            window.history.pushState(null, '', `?product_id=${device.id}`);
            displayProductDetails(device.id);
        });
        container.appendChild(div);
      });
    }

    // Function to display single product details
    async function displayProductDetails(productId) {
        showSection(productDetailsSection);
        
        try {
            const res = await fetch(`/api/products/${productId}`);
            const product = await res.json();

            if (res.ok) {
                document.getElementById('productName').textContent = product.name;
                // Note: product.batterylife from DB, but frontend uses productBatteryLife for display
                document.getElementById('productPrice').textContent = product.price;
                document.getElementById('productBatteryLife').textContent = product.batterylife ? `${product.batterylife} ore` : 'N/A';
                document.getElementById('productType').textContent = product.type;
                document.getElementById('productFeatures').textContent = product.features.join(', ');
                
                const productLinkElement = document.getElementById('productLink');
                if (product.link && product.link !== 'null') {
                    productLinkElement.href = product.link;
                    productLinkElement.style.display = 'inline';
                    productLinkElement.textContent = product.link;
                } else {
                    productLinkElement.style.display = 'none';
                }
            } else {
                productDetailsSection.innerHTML = `<p class="no-results">Eroare: ${product.message || 'Produsul nu a putut fi încărcat.'}</p>`;
            }
        } catch (error) {
            console.error('Eroare la preluarea detaliilor produsului:', error);
            productDetailsSection.innerHTML = '<p class="no-results">A apărut o eroare la încărcarea detaliilor produsului.</p>';
        }
    }

    // Event listener for "Back to Recommendations" button
    backToRecommendationsButton.addEventListener('click', () => {
        window.history.pushState(null, '', '/');
        showSection(recommendationsListSection);
        fetchRecommendations();
    });

    document.getElementById('searchInput').addEventListener('input', () => {
      if (productDetailsSection.style.display === 'block') {
        window.history.pushState(null, '', '/');
        showSection(recommendationsListSection);
      }
      fetchRecommendations(document.getElementById('searchInput').value);
    });

    document.querySelectorAll('#filters input, #filters select').forEach(el => {
      el.addEventListener('input', () => {
        if (productDetailsSection.style.display === 'block') {
          window.history.pushState(null, '', '/');
          showSection(recommendationsListSection);
        }
        fetchRecommendations(document.getElementById('searchInput').value);
      });
    });

    // --- Initial page load routing ---
    function handleInitialRoute() {
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('product_id');

        if (productId) {
            displayProductDetails(productId);
        } else {
            showSection(recommendationsListSection);
            fetchRecommendations();
        }
    }
    window.addEventListener('popstate', handleInitialRoute);
    handleInitialRoute();


    // --- Login/Register Modal Logic ---
    const loginButton = document.getElementById('loginButton');
    const logoutButton = document.getElementById('logoutButton');
    const loginModal = document.getElementById('loginModal');
    const closeLoginButton = document.querySelector('.login-close-button');
    const loginSubmitButton = document.getElementById('loginSubmit');
    const registerSubmitButton = document.getElementById('registerSubmit');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const statusMessageDiv = document.getElementById('statusMessage');
    const authStatusDiv = document.getElementById('authStatus');
    const welcomeMessageSpan = document.getElementById('welcomeMessage');

    let tokenExpiryCheckInterval;

    // Show login modal
    loginButton.addEventListener('click', () => {
      loginModal.style.display = 'flex';
      statusMessageDiv.textContent = '';
      statusMessageDiv.className = '';
    });

    // Hide login modal
    closeLoginButton.addEventListener('click', () => {
      loginModal.style.display = 'none';
    });

    // Hide login modal if clicked outside of modal content
    window.addEventListener('click', (event) => {
      if (event.target == loginModal) {
        loginModal.style.display = 'none';
      }
    });

    // Function to display status messages for login/register
    function showAuthStatusMessage(message, type) {
      statusMessageDiv.textContent = message;
      statusMessageDiv.className = type;
    }

    // Function to decode JWT to get expiry time (exp)
    function decodeJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        } catch (e) {
            console.error("Failed to decode JWT:", e);
            return null;
        }
    }

    // Function to check token expiry
    function checkTokenExpiry() {
        const token = localStorage.getItem('token');
        if (token) {
            const decodedToken = decodeJwt(token);
            if (decodedToken && decodedToken.exp) {
                const currentTime = Date.now() / 1000;
                if (decodedToken.exp < currentTime) {
                    console.log("Token expired. Logging out...");
                    logoutUser();
                    return;
                }
            }
        }
        if (!token) {
            updateAuthUI();
        }
    }

    // Update UI based on authentication status (including admin button)
    function updateAuthUI() {
      const token = localStorage.getItem('token');
      const role = localStorage.getItem('userRole');
      const username = localStorage.getItem('username');
      const addProductButton = document.getElementById('addProductButton');

      if (tokenExpiryCheckInterval) {
          clearInterval(tokenExpiryCheckInterval);
      }

      if (token && role && username) {
        loginButton.style.display = 'none';
        authStatusDiv.style.display = 'flex';
        welcomeMessageSpan.textContent = `Bine ai venit, ${username} (${role})!`;
        logoutButton.style.display = 'block';

        if (role === 'admin') {
            addProductButton.style.display = 'block';
        } else {
            addProductButton.style.display = 'none';
        }

        tokenExpiryCheckInterval = setInterval(checkTokenExpiry, 5000);
      } else {
        loginButton.style.display = 'block';
        authStatusDiv.style.display = 'none';
        welcomeMessageSpan.textContent = '';
        logoutButton.style.display = 'none';
        addProductButton.style.display = 'none';
      }
      // Re-fetch recommendations to apply admin controls to product cards
      fetchRecommendations(document.getElementById('searchInput').value);
    }

    // Login function
    loginSubmitButton.addEventListener('click', async (event) => {
      event.preventDefault();
      const username = usernameInput.value;
      const password = passwordInput.value;

      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ username, password }),
        });

        const data = await response.json();

        if (response.ok) {
          showAuthStatusMessage(data.message, 'success');
          localStorage.setItem('token', data.token);
          localStorage.setItem('userRole', data.role);
          localStorage.setItem('username', data.username);
          updateAuthUI();
          setTimeout(() => {
            loginModal.style.display = 'none';
          }, 1500);
        } else {
          showAuthStatusMessage(data.message || 'Eroare la conectare.', 'error');
        }
      } catch (error) {
        console.error('Eroare la conectare:', error);
        showAuthStatusMessage('Eroare la conectare. Vă rugăm să încercați din nou.', 'error');
      }
    });

    // Register function
    registerSubmitButton.addEventListener('click', async (event) => {
      event.preventDefault();
      const username = usernameInput.value;
      const password = passwordInput.value;

      const minLength = 6;
      const hasUppercase = /[A-Z]/.test(password);
      const hasDigit = /\d/.test(password);

      if (password.length < minLength) {
        showAuthStatusMessage(`Parola trebuie să aibă minim ${minLength} caractere.`, 'error');
        return;
      }
      if (!hasUppercase) {
        showAuthStatusMessage('Parola trebuie să conțină cel puțin o literă mare.', 'error');
        return;
      }
      if (!hasDigit) {
        showAuthStatusMessage('Parola trebuie să conțină cel puțin o cifră.', 'error');
        return;
      }

      try {
        const response = await fetch('/api/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ username, password }),
        });

        const data = await response.json();

        if (response.ok) {
          showAuthStatusMessage(data.message, 'success');
        } else {
          showAuthStatusMessage(data.message || 'Eroare la înregistrare.', 'error');
        }
      } catch (error) {
        console.error('Eroare la înregistrare:', error);
        showAuthStatusMessage('Eroare la înregistrare. Vă rugăm să încercați din nou.', 'error');
      }
    });

    // Logout function
    function logoutUser() {
      localStorage.removeItem('token');
      localStorage.removeItem('userRole');
      localStorage.removeItem('username');
      if (tokenExpiryCheckInterval) {
          clearInterval(tokenExpiryCheckInterval);
      }
      updateAuthUI();
      showAuthStatusMessage('Ați fost deconectat cu succes.', 'success');
      window.history.pushState(null, '', '/');
      showSection(recommendationsListSection);
      fetchRecommendations();
    }
    logoutButton.addEventListener('click', logoutUser);

    // --- Add Product Modal Logic ---
    const addProductModal = document.getElementById('addProductModal');
    const closeAddProductButton = document.querySelector('.add-product-close-button');
    const submitProductButton = document.getElementById('submitProduct');
    const productNameInput = document.getElementById('productNameInput');
    const productPriceInput = document.getElementById('productPriceInput');
    const productBatteryLifeInput = document.getElementById('productBatteryLifeInput');
    const productTypeInput = document.getElementById('productTypeInput');
    const productFeaturesInput = document.getElementById('productFeaturesInput');
    const productLinkInput = document.getElementById('productLinkInput');
    const addProductStatusMessageDiv = document.getElementById('addProductStatusMessage');

    // Show add product modal
    document.getElementById('addProductButton').addEventListener('click', () => {
      addProductModal.style.display = 'flex';
      addProductStatusMessageDiv.textContent = '';
      addProductStatusMessageDiv.className = '';
      document.getElementById('productForm').reset();
    });

    // Hide add product modal
    closeAddProductButton.addEventListener('click', () => {
      addProductModal.style.display = 'none';
    });

    // Hide add product modal if clicked outside of modal content
    window.addEventListener('click', (event) => {
      if (event.target == addProductModal) {
        addProductModal.style.display = 'none';
      }
    });

    // Function to display status messages for add product form
    function showAddProductStatusMessage(message, type) {
        addProductStatusMessageDiv.textContent = message;
        addProductStatusMessageDiv.className = type;
    }

    // Submit new product
    submitProductButton.addEventListener('click', async (event) => {
        event.preventDefault();

        const name = productNameInput.value.trim();
        const price = parseFloat(productPriceInput.value);
        const batteryLife = productBatteryLifeInput.value ? parseInt(productBatteryLifeInput.value, 10) : null;
        const type = productTypeInput.value;
        const features = productFeaturesInput.value.split(',').map(f => f.trim()).filter(f => f.length > 0);
        const link = productLinkInput.value.trim();

        // Frontend validation for add product form
        if (!name || isNaN(price) || price <= 0 || !type || features.length === 0) {
            showAddProductStatusMessage('Vă rugăm să completați toate câmpurile obligatorii: Nume, Preț, Tip și cel puțin o Caracteristică.', 'error');
            return;
        }

        const token = localStorage.getItem('token');
        if (!token) {
            showAddProductStatusMessage('Nu sunteți autentificat. Vă rugăm să vă conectați ca administrator.', 'error');
            return;
        }

        try {
            const response = await fetch('/api/products', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ name, price, batteryLife, type, features, link })
            });

            const data = await response.json();

            if (response.ok) {
                showAddProductStatusMessage(data.message, 'success');
                document.getElementById('productForm').reset();
                fetchRecommendations();
                setTimeout(() => {
                    addProductModal.style.display = 'none';
                }, 1500);
            } else {
                showAddProductStatusMessage(data.message || 'Eroare la adăugarea produsului.', 'error');
            }
        } catch (error) {
            console.error('Eroare la adăugarea produsului:', error);
            showAddProductStatusMessage('A apărut o eroare la trimiterea datelor. Vă rugăm să încercați din nou.', 'error');
        }
    });

    // --- Edit Product Modal Logic ---
    const editProductModal = document.getElementById('editProductModal');
    const closeEditProductButton = document.querySelector('.edit-product-close-button');
    const updateProductButton = document.getElementById('updateProduct');
    const editProductIdInput = document.getElementById('editProductId');
    const editProductNameInput = document.getElementById('editProductNameInput');
    const editProductPriceInput = document.getElementById('editProductPriceInput');
    const editProductBatteryLifeInput = document.getElementById('editProductBatteryLifeInput');
    const editProductTypeInput = document.getElementById('editProductTypeInput');
    const editProductFeaturesInput = document.getElementById('editProductFeaturesInput');
    const editProductLinkInput = document.getElementById('editProductLinkInput');
    const editProductStatusMessageDiv = document.getElementById('editProductStatusMessage');

    // Function to show status messages for edit product form
    function showEditProductStatusMessage(message, type) {
        editProductStatusMessageDiv.textContent = message;
        editProductStatusMessageDiv.className = type;
    }

    // Open edit product modal and populate with data
    async function openEditProductModal(productId) {
        editProductStatusMessageDiv.textContent = '';
        editProductStatusMessageDiv.className = '';
        
        try {
            const res = await fetch(`/api/products/${productId}`);
            const product = await res.json();

            if (res.ok) {
                editProductIdInput.value = product.id;
                editProductNameInput.value = product.name;
                editProductPriceInput.value = product.price;
                editProductBatteryLifeInput.value = product.batterylife || '';
                editProductTypeInput.value = product.type;
                editProductFeaturesInput.value = product.features.join(', ');
                editProductLinkInput.value = product.link && product.link !== 'null' ? product.link : '';

                editProductModal.style.display = 'flex';
            } else {
                showAuthStatusMessage(product.message || 'Eroare la preluarea datelor produsului pentru editare.', 'error');
            }
        } catch (error) {
            console.error('Error fetching product for edit:', error);
            showAuthStatusMessage('A apărut o eroare la încărcarea datelor produsului pentru editare.', 'error');
        }
    }

    // Hide edit product modal
    closeEditProductButton.addEventListener('click', () => {
      editProductModal.style.display = 'none';
    });

    // Hide edit product modal if clicked outside of modal content
    window.addEventListener('click', (event) => {
      if (event.target == editProductModal) {
        editProductModal.style.display = 'none';
      }
    });

    // Submit updated product
    updateProductButton.addEventListener('click', async (event) => {
        event.preventDefault();

        const productId = editProductIdInput.value;
        const name = editProductNameInput.value.trim();
        const price = parseFloat(editProductPriceInput.value);
        const batteryLife = editProductBatteryLifeInput.value ? parseInt(editProductBatteryLifeInput.value, 10) : null;
        const type = editProductTypeInput.value;
        const features = editProductFeaturesInput.value.split(',').map(f => f.trim()).filter(f => f.length > 0);
        const link = editProductLinkInput.value.trim();

        // Frontend validation for edit product form
        if (!name || isNaN(price) || price <= 0 || !type || features.length === 0) {
            showEditProductStatusMessage('Vă rugăm să completați toate câmpurile obligatorii: Nume, Preț, Tip și cel puțin o Caracteristică.', 'error');
            return;
        }

        const token = localStorage.getItem('token');
        if (!token) {
            showEditProductStatusMessage('Nu sunteți autentificat. Vă rugăm să vă conectați ca administrator.', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/products/${productId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ name, price, batteryLife, type, features, link })
            });

            const data = await response.json();

            if (response.ok) {
                showEditProductStatusMessage(data.message, 'success');
                fetchRecommendations(); // Refresh product list
                setTimeout(() => {
                    editProductModal.style.display = 'none';
                }, 1500);
            } else {
                showEditProductStatusMessage(data.message || 'Eroare la actualizarea produsului.', 'error');
            }
        } catch (error) {
            console.error('Eroare la actualizarea produsului:', error);
            showEditProductStatusMessage('A apărut o eroare la trimiterea datelor. Vă rugăm să încercați din nou.', 'error');
        }
    });

    // Delete Product function
    async function deleteProduct(productId) {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('Nu sunteți autentificat. Vă rugăm să vă conectați ca administrator.'); // Consider a custom modal instead of alert
            return;
        }

        try {
            const response = await fetch(`/api/products/${productId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const data = await response.json();

            if (response.ok) {
                alert(data.message); // Consider a custom modal instead of alert
                fetchRecommendations(); // Refresh product list
            } else {
                alert(data.message || 'Eroare la ștergerea produsului.'); // Consider a custom modal instead of alert
            }
        } catch (error) {
            console.error('Eroare la ștergerea produsului:', error);
            alert('A apărut o eroare la ștergerea produsului. Vă rugăm să încercați din nou.'); // Consider a custom modal instead of alert
        }
    }

    // Initial UI update on page load
    updateAuthUI();
  </script>
</body>
</html>
